<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>画饼记录系统</title>
<style>
  :root{
    --green:#118a34;
    --red:#c62828;
    --brown:#8d6e63;
    --ink:#111;
    --muted:#666;
    --border:#111;
    --bg:#fff;
    --pill:#eaeaea;
    --pill-active:#d0ebff;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.6 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans CJK SC","PingFang SC","Microsoft YaHei",sans-serif}
  .wrap{max-width:1000px;margin:24px auto;padding:16px 20px;border:6px solid var(--border);box-shadow:0 8px 24px rgba(0,0,0,.05)}
  header{display:flex;align-items:center;gap:16px;margin:8px 0 18px}
  .logo{width:72px;height:72px;border:6px solid var(--border);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:22px}
  .titles h1{margin:0;font-size:38px;letter-spacing:1px}
  .titles .slogan{margin-top:4px;color:#333;font-weight:500}

  /* 统计卡片 */
  .stats{border:6px solid var(--border);padding:16px 18px;border-radius:14px}
  .stats .row{display:flex;flex-wrap:wrap;gap:22px}
  .stats .row+.row{margin-top:10px}
  .kpi{font-weight:800}
  .kpi .num{font-size:22px;margin-left:6px}
  .kpi.total{color:var(--ink)}
  .kpi.done{color:var(--green)}
  .kpi.dead{color:var(--red)}
  .kpi.wip{color:var(--brown)}
  .pct{color:#333}
  .pct strong{margin:0 6px}

  /* 标签筛选 */
  .filters{margin:18px 0 8px;display:flex;flex-wrap:wrap;gap:10px}
  .tag{cursor:pointer;border:2px solid var(--border);padding:4px 10px;border-radius:999px;background:var(--pill);font-weight:600;user-select:none}
  .tag.active{outline:3px solid #0b6cff;background:var(--pill-active)}
  .tag.muted{opacity:.5}

  /* 列表表头 */
  .list{margin-top:8px;border-top:4px solid var(--border)}
  .thead, .rowItem{display:grid;grid-template-columns: 3fr 1.4fr 1.8fr 1.2fr 2fr 2fr;gap:18px;padding:12px 4px}
  .thead{font-weight:800}
  .thead span{border-bottom:0}
  .rowItem{border-bottom:1px solid #ddd}
  .title{font-weight:800;margin:0 0 4px;font-size:18px}
  .content{white-space:pre-wrap}
  .when{white-space:nowrap}
  .badge{display:inline-block;margin:3px 6px 0 0;padding:2px 8px;border:2px solid var(--border);border-radius:999px;background:#fafafa;font-weight:600}
  .yes{font-weight:800}
  .state{font-weight:800}
  .state.green{color:var(--green)}
  .state.red{color:var(--red)}
  .state.brown{color:var(--brown)}
  .notes{white-space:pre-wrap;color:#333}
  .muted{color:var(--muted)}
  .empty{padding:18px 0;color:var(--muted)}
  @media (max-width:920px){
    .thead{display:none}
    .rowItem{grid-template-columns: 1fr;gap:4px 0}
    .field-label{display:inline-block;min-width:6em;color:var(--muted);font-weight:700}
    .when,.yes,.state,.notes{margin-left:0}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">logo</div>
      <div class="titles">
        <h1>画饼记录系统</h1>
        <div class="slogan">记录承诺，按图索饼</div>
      </div>
    </header>

    <section class="stats" id="stats">
      <div class="row">
        <div class="kpi total">总饼数 <span class="num" id="total">-</span></div>
        <div class="kpi done">已完成 <span class="num" id="done">-</span></div>
        <div class="kpi dead">烂尾 <span class="num" id="dead">-</span></div>
        <div class="kpi wip">未到期 <span class="num" id="wip">-</span></div>
      </div>
      <div class="row pct">
        <div>画饼实现率<strong id="rate-done">-</strong></div>
        <div>烂尾率<strong id="rate-dead">-</strong></div>
        <div>承诺定时率<strong id="rate-timed">-</strong></div>
      </div>
    </section>

    <section>
      <div class="filters" id="filterTags"></div>
    </section>

    <section class="list">
      <div class="thead">
        <span>画饼内容</span>
        <span>画饼时间</span>
        <span>标签</span>
        <span>是否承诺完成时间</span>
        <span>画饼现状</span>
        <span>备注</span>
      </div>
      <div id="list"></div>
    </section>

    <div class="empty" id="empty" hidden>暂无数据</div>
  </div>

<script>
/* ====== 工具函数 ====== */
function parseDate(s){
  if(!s) return null;
  const t = String(s).trim()
    .replace(/[年月\/\.]/g,'-').replace(/日/g,'')
    .replace(/\s+$/, '');
  const d = new Date(t);
  return isNaN(d.getTime()) ? null : new Date(d.getFullYear(), d.getMonth(), d.getDate());
}
function fmtDate(d){
  if(!d) return '';
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0');
  return `${y}.${m}.${da}`;
}
function daysBetween(a,b){ // 整天差
  const ms = 24*60*60*1000;
  const x = new Date(a.getFullYear(),a.getMonth(),a.getDate()).getTime();
  const y = new Date(b.getFullYear(),b.getMonth(),b.getDate()).getTime();
  return Math.round((y-x)/ms);
}
function nonEmpty(s){ return s != null && String(s).trim()!==''; }
function truthyCN(s){
  const v=String(s||'').trim().toLowerCase();
  return ['是','true','y','yes','1'].includes(v);
}

/* ====== 解析 TSV ====== */
function parseTSV(text){
  const lines = text.split(/\r?\n/).filter(l=>l.trim()!=='');
  if(lines.length===0) return [];
  const headers = lines[0].split('\t').map(h=>h.trim());
  const idx = (name)=>headers.indexOf(name);
  const out=[];
  for(let i=1;i<lines.length;i++){
    const cols=lines[i].split('\t');
    const obj={
      id: cols[idx('id')]?.trim() ?? '',
      title: cols[idx('title')]?.trim() ?? '',
      content: cols[idx('content')]?.trim() ?? '',
      promised_at: cols[idx('promised_at')]?.trim() ?? '',
      is_timed: cols[idx('is_timed')]?.trim() ?? '',
      due_at: cols[idx('due_at')]?.trim() ?? '',
      tags: cols[idx('tags')]?.trim() ?? '',
      completed_at: cols[idx('completed_at')]?.trim() ?? '',
      notes: cols[idx('notes')]?.trim() ?? ''
    };
    out.push(obj);
  }
  return out;
}

/* ====== 状态计算 ======
  1 未定期（没有约定日期）
  2 逾期完成（due存在 & completed存在 & completed > due）
  3 完成（due存在 & completed存在 & completed <= due）
  4 进行中（due存在 & completed缺失 & 今天 <= due）
  5 烂尾（due存在 & completed缺失 & 今天 > due）
*/
function computeStatus(row, today){
  const promised = parseDate(row.promised_at);
  const due = parseDate(row.due_at);
  const done = parseDate(row.completed_at);
  const hasDue = nonEmpty(row.due_at) && !!due && truthyCN(row.is_timed) || (!!due && !nonEmpty(row.is_timed)); // 兼容：有日期即视为定期
  if(!hasDue){
    const days = promised ? daysBetween(promised, today) : 0;
    return {code:1, text:`已画饼${days}天`, cls:'red'};
  }
  if(done){
    if(done.getTime() > due.getTime()){
      const over = daysBetween(due, done);
      return {code:2, text:`超期${over}天完成`, cls:'red'};
    }else{
      return {code:3, text:`完成`, cls:'green'};
    }
  }
  if(today.getTime() <= due.getTime()){
    const left = Math.max(0, daysBetween(today, due));
    return {code:4, text:`还剩${left}天`, cls:'brown'};
  }
  const late = daysBetween(due, today);
  return {code:5, text:`已烂尾${late}天`, cls:'red'};
}

/* ====== 渲染 ====== */
const state = {
  raw: [],
  rows: [],
  tags: [],
  selectedTag: null
};

function renderStats(rows){
  const total = rows.length;
  const s2 = rows.filter(r=>r._status.code===2).length;
  const s3 = rows.filter(r=>r._status.code===3).length;
  const s4 = rows.filter(r=>r._status.code===4).length;
  const s5 = rows.filter(r=>r._status.code===5).length;
  const done = s2+s3;

  document.getElementById('total').textContent = total;
  document.getElementById('done').textContent = done;
  document.getElementById('dead').textContent = s5;
  document.getElementById('wip').textContent = s4;

  function pct(n,d){ return d? (Math.round(n/d*1000)/10).toFixed(1)+'%' : '0%'; }
  document.getElementById('rate-done').textContent = pct(done,total);
  document.getElementById('rate-dead').textContent = pct(s5,total);
  // 承诺定时率 = 状态2+3+4+5 / 总饼数
  document.getElementById('rate-timed').textContent = pct(s2+s3+s4+s5, total);
}

function renderFilters(tags){
  const box = document.getElementById('filterTags');
  box.innerHTML='';
  tags.forEach(t=>{
    const span=document.createElement('span');
    span.className='tag'+(state.selectedTag===t?' active':'');
    span.textContent = t;
    span.onclick=()=>{
      state.selectedTag = (state.selectedTag===t)?null:t;
      renderFilters(state.tags);
      renderList();
    };
    box.appendChild(span);
  });
}

function renderList(){
  const list = document.getElementById('list');
  list.innerHTML='';
  const filtered = state.selectedTag
    ? state.rows.filter(r=>r._tags.includes(state.selectedTag))
    : state.rows.slice();

  if(filtered.length===0){
    document.getElementById('empty').hidden=false;
    return;
  }else{
    document.getElementById('empty').hidden=true;
  }

  filtered.forEach(r=>{
    const row = document.createElement('div');
    row.className='rowItem';

    // 画饼内容
    const c1 = document.createElement('div');
    const h = document.createElement('div'); h.className='title'; h.textContent = r.title || '（未命名）';
    const p = document.createElement('div'); p.className='content'; p.textContent = r.content || '';
    c1.appendChild(h); c1.appendChild(p);

    // 画饼时间
    const c2 = document.createElement('div');
    const promised = parseDate(r.promised_at);
    c2.innerHTML = `<span class="when">${promised?fmtDate(promised):'<span class="muted">无</span>'}</span>`;

    // 标签
    const c3 = document.createElement('div');
    if(r._tags.length===0){
      c3.innerHTML = '<span class="muted">无</span>';
    }else{
      r._tags.forEach(t=>{
        const b=document.createElement('span');
        b.className='badge';
        b.textContent=t;
        // 高亮已选筛选项
        if(state.selectedTag && t===state.selectedTag){
          b.style.outline='3px solid #0b6cff';
          b.style.background='var(--pill-active)';
        }
        c3.appendChild(b);
      })
    }

    // 是否承诺完成时间
    const c4 = document.createElement('div');
    const hasDue = nonEmpty(r.due_at) && !!parseDate(r.due_at);
    c4.innerHTML = `<span class="yes">${hasDue?'是':'否'}</span>`;

    // 画饼现状
    const c5 = document.createElement('div');
    const s = r._status;
    c5.innerHTML = `<span class="state ${s.cls}">${s.text}</span>`;

    // 备注
    const c6 = document.createElement('div');
    c6.className='notes';
    c6.textContent = r.notes||'';

    row.append(c1,c2,c3,c4,c5,c6);
    list.appendChild(row);
  });
}

/* ====== 启动 ====== */
(async function(){
  try{
    const resp = await fetch('data.tsv',{cache:'no-store'});
    const text = await resp.text();
    state.raw = parseTSV(text);

    const today = new Date(); // 本地时区
    state.rows = state.raw.map(r=>{
      const status = computeStatus(r, today);
      const tags = String(r.tags||'')
        .split(/[,，\s、]+/).map(s=>s.trim()).filter(Boolean);
      return {...r, _status:status, _tags:tags};
    });

    // 汇总所有标签（去重、保持原样）
    const allTags = new Set();
    state.rows.forEach(r=>r._tags.forEach(t=>allTags.add(t)));
    state.tags = Array.from(allTags);

    renderStats(state.rows);
    renderFilters(state.tags);
    renderList();
  }catch(err){
    console.error(err);
    document.getElementById('empty').hidden=false;
    document.getElementById('empty').textContent='数据加载失败：请确认 data.tsv 存在且可访问';
  }
})();
</script>
</body>
</html>
