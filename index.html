<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>剑网3画饼记录系统 · 承诺追踪站</title>
  <style>
    :root{
      --bg:#0b0d10;--panel:#11161b;--muted:#8aa0b3;--text:#e7eef5;--brand:#6aa3ff;--ok:#1f9d55;--ok2:#8bd28b;--warn:#9aa7b2;--bad:#e74c3c;--black:#e7eef5;--chip:#22303d;--chip-border:#2e3f51;--border:#1f2a36;--gray:#9aa7b2;--white:#ffffff
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:14px/1.65 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial}
    a{color:var(--brand);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:48px;height:48px;border:2px solid var(--border);border-radius:10px;display:grid;place-items:center;font-weight:700}
    h1{font-size:24px;margin:0}
    .slogan{color:var(--muted);margin-top:2px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:6px}
    .stat{background:#0f141a;border:1px solid #233040;border-radius:12px;padding:10px 12px;text-align:center;font-weight:700}
    .c-black{color:var(--black)}
    .c-green{color:var(--ok)}
    .c-red{color:var(--bad)}
    .c-brown { color: #9aa7b2; }
    .pct{color:var(--muted);display:flex;gap:18px;flex-wrap:wrap;padding:8px 2px 0}

    /* 统计图布局 */
    .chartRow{display:flex;gap:24px;align-items:center;margin-top:10px}
    .legend{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:8px;color:#cdd9e5}
    .legend li{font-size:14px}
    .legend .dot{display:inline-block;width:12px;height:12px;border-radius:50%;margin-right:8px;border:1px solid #233040;vertical-align:middle}
    .legend .val{font-weight:800;color:var(--text)}

    .tagbar{display:flex;gap:8px;flex-wrap:wrap;margin:14px 0}
    /* 让标签气泡内不换行，只在气泡之间换行 */
    .chip{background:var(--chip);border:1px solid var(--chip-border);padding:4px 10px;border-radius:999px;color:#c7d6e6;cursor:pointer;user-select:none;display:inline-flex;align-items:center;white-space:nowrap;word-break:keep-all;line-height:1.1}
    .tags{display:flex;flex-wrap:wrap;gap:8px}
    .chip.active{outline:2px solid var(--brand)}

    table{width:100%;border-collapse:collapse;table-layout:fixed}
    th,td{padding:10px 8px;border-bottom:1px dashed #233040;vertical-align:top}
    th{color:#b9c9da;text-align:left;position:sticky;top:0;background:var(--panel);white-space:nowrap}
    tr:hover{background:#0f151b}
    .big{font-weight:800}
    .meta{color:var(--muted);font-size:12px}

    /* 备注区链接：默认带下划线 */
    .note{color:#d7e6ff;word-break:break-all}
    .note a{ color: var(--brand); text-decoration: underline; }
    .note a:hover{ text-decoration: underline; }

    .state-green{color:var(--ok);font-weight:700}
    .state-red{color:var(--bad);font-weight:700}
    .state-brown{color:var(--warn);font-weight:700}

    .footer{margin-top:12px;color:var(--muted)}
    .notice{margin:8px 0;color:#ffd9a7}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- 顶部 -->
    <header>
      <div class="brand">
        <div class="logo">logo</div>
        <div>
          <h1>剑网3画饼记录系统</h1>
          <div class="slogan">来人，喂公子吃饼！</div>
        </div>
      </div>
      <div class="meta" id="version"></div>
    </header>

    <!-- 数据统计 -->
    <section class="panel" id="statPanel">
      <div class="stats">
        <div class="stat c-black">总饼数 <span id="s-total">0</span></div>
        <div class="stat c-green">已完成 <span id="s-done">0</span></div>
        <div class="stat c-red">烂尾 <span id="s-bad">0</span></div>
        <div class="stat c-brown">未到期 <span id="s-pending">0</span></div>
      </div>
      <div class="pct" id="s-pct"></div>
      <div class="chartRow">
        <canvas id="pie" width="360" height="240" style="background:#0f141a;border:1px solid #233040;border-radius:12px"></canvas>
        <ul class="legend" id="legendList"></ul>
      </div>
    </section>

    <!-- 标签筛选 -->
    <section class="panel">
      <div class="meta" style="margin-bottom:6px">点击标签进行筛选，再次点击取消</div>
      <div class="tagbar" id="tagbar"></div>
    </section>

    <!-- 正文表格 -->
    <section class="panel">
      <div class="notice" id="notice"></div>
      <div style="overflow:auto; max-height:70vh;">
        <table id="tbl">
          <thead>
            <tr>
              <th style="width:36%">画饼内容</th>
              <th style="width:14%">画饼时间</th>
              <th style="width:22%">标签</th>
              <th style="width:12%">预计出锅</th>
              <th style="width:10%">画饼现状</th>
              <th style="width:16%">备注</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="footer"><span id="count">0</span> 条记录 · 数据来自 <code>data.tsv</code> 或 <code>data.csv</code></div>
    </section>

  </div>

<script>
// =============================
// 可配置：微博链接地址
const WEIBO_URL = 'https://weibo.com/u/5722431373'; // 需要时替换为目标地址

// =============================
// 内置最小示例，缺文件时用于自检
const fallbackText = `id\ttitle\tcontent\tpromised_at\tis_timed\tdue_at\ttags\tcompleted_at\tnotes
p_2025_0001\t修复bug\t我们计划在一周内修复50个bug，来源是……\t2025-08-24\t是\t2025-08-31\t#bug修复|#外观优化|#布料\t\t查看：https://example.com/plan ，以及参考 www.example.org/notes`;

// ------- DOM 安全助手 -------
const $ = (id)=> document.getElementById(id);
const setText = (id, text)=>{ const el=$(id); if(el) el.textContent = text; };
const setHTML = (id, html)=>{ const el=$(id); if(el) el.innerHTML = html; };

// -------- 数据加载：优先 TSV，再 CSV；禁缓存 --------
async function loadDataText(){
  const tryFetch = async (name) => {
    try {
      const r = await fetch(name, {cache:'no-store'});
      if (!r.ok) throw 0; const t = await r.text();
      if (!t.trim()) throw 0; return t;
    } catch { return null; }
  };
  return await tryFetch('data.tsv') ?? await tryFetch('data.csv');
}

// -------- 解析器：自动判断分隔符；CSV 兼容 RFC4180 引号 --------
function parseTable(text){
  const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
  if (!lines.length) return [];
  const headerLine = lines[0];
  let delim = '\t';
  if (!/\t/.test(headerLine)) {
    const count = (s, ch) => (s.split(ch).length - 1);
    const comma = count(headerLine, ',');
    const semi  = count(headerLine, ';');
    delim = semi > comma ? ';' : ',';
  }
  const splitLine = (line) => {
    if (delim === '\t') return line.split('\t');
    const out = []; let cur = ''; let q = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (q) {
        if (ch === '"') { if (line[i + 1] === '"') { cur += '"'; i++; } else { q = false; } }
        else cur += ch;
      } else {
        if (ch === '"') q = true;
        else if (ch === delim) { out.push(cur); cur = ''; }
        else cur += ch;
      }
    }
    out.push(cur); return out;
  };
  let header = splitLine(lines[0]).map(h => h.trim());
  if (header.length) header[0] = header[0].replace(/^\ufeff/, '');
  return lines.slice(1).map(line => {
    const cells = splitLine(line);
    const o = {}; header.forEach((h, i) => o[h] = (cells[i] ?? '').trim());
    o.tags = o.tags ? o.tags.split('|').map(s => s.trim()).filter(Boolean) : [];
    return o;
  });
}

// -------- 日期与状态 --------
function d(s){ if(!s) return null; const t = String(s).replace(/\./g,'-'); const dt = new Date(t); return isNaN(dt)? null: new Date(dt.getFullYear(),dt.getMonth(),dt.getDate()); }
function today(){ const now = new Date(); return new Date(now.getFullYear(), now.getMonth(), now.getDate()); }
function daysBetween(a,b){ if(!a||!b) return 0; return Math.floor((b-a)/86400000); }
function fmtDate(s){ const dt=d(s); if(!dt) return ''; const mm=String(dt.getMonth()+1).padStart(2,'0'); const dd=String(dt.getDate()).padStart(2,'0'); return `${dt.getFullYear()}.${mm}.${dd}`; }

function computeState(row){
  const now=today(), promised=d(row.promised_at), due=d(row.due_at), completed=d(row.completed_at);
  const isTimed=/^(是|true)$/i.test(row.is_timed||'');
  if(!isTimed || !due){ return {code:1,text:`已画饼${daysBetween(promised,now)}天`,cls:'state-red'}; }
  if(completed){
    if(completed>due) return {code:2,text:`超期${daysBetween(due,completed)}天完成`,cls:'state-red'};
    return {code:3,text:'完成',cls:'state-green'};
  }
  if(now<=due) return {code:4,text:`还剩${daysBetween(now,due)}天`,cls:'state-brown'};
  return {code:5,text:`已烂尾${daysBetween(due,now)}天`,cls:'state-red'};
}

function esc(s){return String(s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]))}

// 更稳健的链接化：识别 http(s)、www.、裸域名，并去掉结尾标点
function linkify(text){
  if(!text) return '';
  const re = /(https?:\/\/[^\s<>"]+|www\.[^\s<>"]+|(?:[a-z0-9-]+\.)+[a-z]{2,}(?:\/[\w\-./?#%&=:+,;@~!*$'()\[\]]*)?)/ig;
  const out=[]; let last=0; let m;
  while((m=re.exec(text))){
    const start=m.index; const raw=m[0];
    if(start>last) out.push(esc(text.slice(last,start)));
    // 去掉末尾常见中文/英文标点
    const trimmed = raw.replace(/[\u3002\uff0c\uff1a\uff1b\uff01\uff1f.,;:!?\)\]]+$/,'');
    const trailing = raw.slice(trimmed.length);
    const href = /^https?:\/\//i.test(trimmed) ? trimmed : 'http://' + trimmed;
    out.push(`<a href="${esc(href)}" target="_blank" rel="noopener">${esc(trimmed)}</a>`);
    if(trailing) out.push(esc(trailing));
    last = start + raw.length;
  }
  if(last < text.length) out.push(esc(text.slice(last)));
  return out.join('');
}

// -------- 表格渲染（包含“预计出锅”列） --------
function renderTable(rows){
  const tbody=document.querySelector('#tbl tbody'); if(!tbody) return;
  tbody.innerHTML='';
  rows.forEach(r=>{
    const st=computeState(r);
    const tr=document.createElement('tr');

    const c1=document.createElement('td');
    c1.innerHTML=`<div class="big">${esc(r.title)}</div><div>${esc(r.content)}</div>`;

    const c2=document.createElement('td'); c2.textContent=fmtDate(r.promised_at);

    const c3=document.createElement('td');
    c3.innerHTML = `<div class="tags">${(r.tags||[]).map(t=>`<span class="chip" style="cursor:default">${esc(t)}</span>`).join('')}</div>`;

    const c4=document.createElement('td'); // 预计出锅
    c4.textContent = r.due_at ? fmtDate(r.due_at) : '无具体时间';

    const c5=document.createElement('td');
    c5.innerHTML=`<span class="${st.cls}">${esc(st.text)}</span>`;

    const c6=document.createElement('td'); c6.innerHTML=`<span class="note">${linkify(r.notes)}</span>`;

    tr.append(c1,c2,c3,c4,c5,c6); tbody.appendChild(tr);
  });
  setText('count', rows.length);
}

// -------- 标签筛选 --------
let currentTag=null;
function buildTagbar(all){
  const set=new Set(); all.forEach(r=> (r.tags||[]).forEach(t=>set.add(t)) );
  const bar=$('tagbar'); if(!bar) return; bar.innerHTML='';
  [...set].sort().forEach(tag=>{
    const s=document.createElement('span'); s.className='chip'; s.textContent=tag; s.dataset.tag=tag;
    s.addEventListener('click',()=>{
      if(s.classList.contains('active')){ s.classList.remove('active'); currentTag=null; applyFilter(all); }
      else{ [...bar.querySelectorAll('.chip')].forEach(x=>x.classList.remove('active')); s.classList.add('active'); currentTag=tag; applyFilter(all); }
    });
    bar.appendChild(s);
  });
}

function applyFilter(all){
  const view=currentTag? all.filter(r=> (r.tags||[]).includes(currentTag) ): all;
  renderTable(view); updateStats(view);
}

// -------- 统计与饼图 --------
function drawPie(counts){
  const canvas = $('pie'); if(!canvas) return; const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const total = Object.values(counts).reduce((a,b)=>a+b,0) || 1;
  const seq = [3,2,4,5,1];
  const colors = {3: getComputedStyle(document.documentElement).getPropertyValue('--ok').trim() || '#1f9d55',
                  2: getComputedStyle(document.documentElement).getPropertyValue('--ok2').trim() || '#8bd28b',
                  4: getComputedStyle(document.documentElement).getPropertyValue('--gray').trim() || '#9aa7b2',
                  5: getComputedStyle(document.documentElement).getPropertyValue('--bad').trim() || '#e74c3c',
                  1: '#ffffff'};
  const cx = canvas.width/2, cy = canvas.height/2; const r = Math.min(cx,cy)-12; let start = -Math.PI/2;
  seq.forEach(code=>{ const val = counts[code]||0; const ang = (val/total)*Math.PI*2;
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,start,start+ang,false); ctx.closePath(); ctx.fillStyle = colors[code]; ctx.fill(); if(code===1){ ctx.strokeStyle='#233040'; ctx.lineWidth=1; ctx.stroke(); } start += ang; });
}

function updateStats(view){
  const total=view.length; const counts={1:0,2:0,3:0,4:0,5:0}; view.forEach(r=>{ counts[computeState(r).code]++; });
  const done = counts[2]+counts[3]; setText('s-total', total); setText('s-done', done); setText('s-bad', counts[5]); setText('s-pending', counts[4]);
  const pct=(n,d)=> d? Math.round(n*1000/d)/10:0;
  const impl=pct(done,total), badr=pct(counts[5],total), timer=pct(total-(counts[1]||0),total);
  setHTML('s-pct', `画饼实现率：${impl}%  ·  烂尾率：${badr}%  ·  承诺定时率：${timer}%`);
  drawPie(counts);
  const legend = $('legendList'); if(!legend) return; const names = {3:'按时出锅',2:'逾期出锅',4:'正在烘烤',5:'烂尾率',1:'吹毛率'};
  const colors = {3: getComputedStyle(document.documentElement).getPropertyValue('--ok').trim() || '#1f9d55',
                  2: getComputedStyle(document.documentElement).getPropertyValue('--ok2').trim() || '#8bd28b',
                  4: getComputedStyle(document.documentElement).getPropertyValue('--gray').trim() || '#9aa7b2',
                  5: getComputedStyle(document.documentElement).getPropertyValue('--bad').trim() || '#e74c3c',
                  1: '#ffffff'};
  const seq=[3,2,4,5,1]; legend.innerHTML = seq.map(code=>`<li><span class="dot" style="background:${colors[code]}"></span>${names[code]}：<span class="val">${pct(counts[code], total)}%</span></li>`).join('');
}

// -------- 启动 --------
(async function start(){
  // 右上角微博名改为超链接
  setHTML('version', `微博：<a href="${WEIBO_URL}" target="_blank" rel="noopener">@剑纯吧官博</a>`);

  const text=await loadDataText();
  if(!text){ setText('notice','未检测到 data.tsv / data.csv，暂用内置示例'); }
  const data=parseTable(text||fallbackText);
  buildTagbar(data); applyFilter(data);
})();
</script>
</body>
</html>
